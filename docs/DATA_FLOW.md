# Потоки данных и API

## 1. Клиент-Серверное взаимодействие

Проект спроектирован для работы с REST API. Из-за отсутствия реального бэкенда на данном этапе, реализован **Mock Router**.

### API Client (`shared/api/client.ts`)
Кастомная обертка над `fetch`.
- **Перехват:** Проверяет, является ли запрос эмулируемым. Если да — возвращает данные из `shared/api/mocks/data.ts` с искусственной задержкой (600ms).
- **Fallback:** Если мок не найден, пытается сделать реальный запрос (позволит плавно перейти на реальный API).

### Мульти-тенанси
Ключевым механизмом является заголовок `X-Shop-Id`.
1. `ShopStore` хранит `currentShopId` (по умолчанию захардкожен или берется из `localStorage`).
2. `ApiClient` автоматически добавляет этот заголовок ко **всем** запросам.
3. Mock API использует этот заголовок, чтобы переключить базу данных (меню, цены, валюту) на лету.

Пример:
- `Shop A` -> запрашивает `/products` -> получает Эспрессо за 150р.
- `Shop B` -> запрашивает `/products` -> получает Эспрессо за 200р (или вообще не получает).

## 2. Server State (TanStack Query)

Используется для кэширования ответов API.
- **Stale Time:** 5 минут (данные считаются свежими долго, чтобы избежать мерцания при навигации).
- **Invalidation:** При смене магазина (`setShopId`) вызывается `queryClient.invalidateQueries()`, что заставляет приложение перезапросить все данные для нового магазина.

Основные ключи:
- `['shop']`: Данные текущего магазина.
- `['categories']`: Список категорий.
- `['products']`: Список всех продуктов (фильтрация происходит на клиенте/моке).

## 3. Client State (Zustand)

### Cart Store (`entities/cart/model/cart.store.ts`)
Управление локальной корзиной.
- **Persist:** Сохраняет данные в `localStorage`.
- **Логика:**
  - Группировка товаров: Один и тот же `productId` с *разными* `addons` считается разными позициями.
  - Уникальный `cartId` генерируется при добавлении в корзину.

### Shop Store (`entities/shop/model/shop.store.ts`)
Хранит настройки сессии пользователя.
- `currentShopId`: ID текущего заведения.
- `deliveryAddress`: Если заполнено, приложение переходит в режим "Доставка".

## 4. Контракты (Zod)

Все входящие и исходящие данные описываются схемами в `packages/shared/schemas/index.ts`.
Это "Source of Truth" для фронтенда и (в будущем) для бэкенда.

Пример:
```typescript
export const ProductSchema = z.object({
  id: z.string(),
  price: z.number().int(), // Цена всегда в копейках/центах!
  // ...
});
```
